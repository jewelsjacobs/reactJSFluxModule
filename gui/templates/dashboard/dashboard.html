{% extends 'web_app_base.html' %}

{% block nav_secondary_content %}
    <!-- TODO:
    - Add class 'active' to the active 'li' view.
    -->
    <li class="rs-nav-item"><a class="rs-nav-link" href="">DC Stats</a></li>
    <li class="rs-nav-item"><a class="rs-nav-link" href="">Messages</a></li>
{% endblock nav_secondary_content %}

{% block title %}
    Dashboard
{% endblock title %}

{% block content_area_body %}
    <div class="rs-inner">
        <h2 class="rs-page-title">Dashboard</h2>

        <div class="stats-well">
            <table class="table table-striped" width=100%>
                <tr>
                    <td>Queries/Sec</td><td>Inserts/Sec</td><td>Updates/Sec</td><td>Deletes/Sec</td><td>Commands/Sec</td>
                </tr>
                <tr>
                    <td><span class="lead" id="query">0</span></td>
                    <td><span class="lead" id="insert">0</span></td>
                    <td><span class="lead" id="update">0</span></td>
                    <td><span class="lead" id="delete">0</span></td>
                    <td><span class="lead" id="command">0</span></td>
                </tr>
            </table>
        </div>
        <div class="histogram-well">
            <h6>Opcounters/Sec</h6>
            <div class="pull-right" id="graphdiv-legend1"></div>
            <br>

            <div class="well-graph" id="graphdiv1"></div>
            <br>

            <h6>Network/Sec</h6>
            <div class="pull-right" id="graphdiv-legend2"></div>
            <br>

            <div class="well-graph" id="graphdiv2"></div>
            <br>

            <h6>Disk Space Usage</h6>
            <div class="pull-right" id="graphdiv-legend3"></div>
            <br>

            <div class="well-graph" id="graphdiv3"></div>
            <br>
        </div>
        <iframe src="https://rpm.newrelic.com/public/charts/lhkU651Os5U" width="500" height="300" scrolling="no" frameborder="no"></iframe>
        <iframe src="https://rpm.newrelic.com/public/charts/lfQcYbJfH0V" width="500" height="300" scrolling="no" frameborder="no"></iframe>

        {% if not has_instances %}
            {% if not account.stripe_account or account.invoiced %}
                <div class="row-fluid">
                    <div class="alert alert-info">
                        <strong>To create an instance, you'll need to add your credit card information below.</strong>
                    </div>
                    <form id="enter_cc_form" name="add_cc_form" method="POST" action="{{ url_for('set_credit_card') }}" windowTitle="Add Credit Card" windowLabel="Add Card">
                        <button type="button" id="add_cc_button" class="btn btn-success cc_button">Add Credit Card</button>
                        <input type="hidden" name="stripe_token" id="stripe_token" returntarget="/">
                    </form>
                </div>
            {% else %}
                <div class="row-fluid">
                    <div class="alert alert-info">
                        You don't have any instances defined. You can <a href="{{ url_for('instances') }}">add an instance here.</a>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="row-fluid">
                <div class="span9">

                    <div class="input-append">
                        <div class="btn-group">
                            <a class="btn btn-primary btn-mini dropdown-toggle" data-toggle="dropdown" href="#">
                                Instance: {{ instance.name }}
                                <span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu">
                                {% for instance in instances %}
                                    <li><a href="{{ url_for('dashboard', selected_instance=instance.name) }}">{{ instance.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <div class="stats-well">
                        <table class="table table-striped" width=100%>
                            <tr>
                                <td>Queries/Sec</td>
                                <td>Inserts/Sec</td>
                                <td>Updates/Sec</td>
                                <td>Deletes/Sec</td>
                                <td>Commands/Sec</td>
                            </tr>
                            <tr>
                                <td><span class="lead" id="query">0</span></td>
                                <td><span class="lead" id="insert">0</span></td>
                                <td><span class="lead" id="update">0</span></td>
                                <td><span class="lead" id="delete">0</span></td>
                                <td><span class="lead" id="command">0</span></td>
                            </tr>
                        </table>
                    </div>

                    <div class="histogram-well">
                        <h6>Opcounters/Sec</h6>
                        <div class="pull-right" id="graphdiv-legend1"></div>
                        <br>

                        <div class="well-graph" id="graphdiv1"></div>
                        <br>

                        <h6>Network/Sec</h6>
                        <div class="pull-right" id="graphdiv-legend2"></div>
                        <br>

                        <div class="well-graph" id="graphdiv2"></div>
                        <br>

                        <h6>Disk Space Usage</h6>
                        <div class="pull-right" id="graphdiv-legend3"></div>
                        <br>

                        <div class="well-graph" id="graphdiv3"></div>
                        <br>
                    </div>
                </div>

                <!-- FIXME: -->
                <div class="span3">
                    <div class="status-well">
                        {% for state in status %}
                            <span class="status status-warning" rel="{{ state['_id'] }}" title="{{ state['description'] }}" name="{{ state['_id'] }}" id="{{ state['_id'] }}">{{ state['_id'] }}</span>
                        {% endfor %}

                        <br><br>
                        <a rel="status_what" title="Status" id="status" data-content="Status shows the status of the various elements of the ObjectRocket system.  Each element shows a simple color to indicate it's status.<br><ul><li><span class='status status-success'>&nbsp;</span>  The component is functioning normal</li><li><span class='status status-warning'>&nbsp;</span>  The component may have a fault, but service is not effected</li><li><span class='status status-important'>&nbsp;</span> The component has experienced a fault.</li></ul><br>More detail on the component failures and/or any service interuptions and/or maintenance can be seen in the <a href={{ url_for('notifications') }}>messages</a> area.">What is this?</a>
                    </div>

                    <div class="plan-well">
                        <table class="table">
                            <thead>
                                <tr><th>Plan</th><th>Zone</th><th>Shards</th><th>Total Size</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>{{ instance.plan }}GB</td><td>{{ instance.zone }}</td><td>{{ instance.shard_count }}</td><td>{{ instance.size }}GB</td></tr>
                            </tbody>
                        </table>

                        <!-- FIXME: -->
                        <a href="{ url_for('cluster', selected_instance=instance.name) }" class="btn btn-primary btn-small">Manage Shards</a>

                        <br><br>
                        <a rel="plan_what" title="Plan" id="plan" data-content="ObjectRocket is a sharded system, when you add space, you do so by adding a shard.  Shards are added in the plan size.  Shards can be added manually at any time, or automatically via the RocketScale&trade; service.">What is this?</a>
                    </div>

                    <div class="messages-well">
                        {% if messages|count > 0 %}
                            {% for message in messages %}
                                <p class="text-warning"><i class="icon-comment"></i> <b>{{ message.date.strftime('%Y-%m-%d %H:%M:%S') }}</b><br>{{ message.message }}</p>
                            {% endfor %}
                        {% else %}
                            <p class="muted">No Messages</p>
                        {% endif %}

                        <div class="pull-right"><a href="{{ url_for('notifications') }}">All Messages</a></div>
                        <a rel="messages_what" title="Messages" id="messages" data-content="This area is when messages about any system issues, actions taken by the system on your behalf, or account or billing problems will be shown. More detail on messages is <a href={{ url_for('notifications') }}>available here</a>.">What is this?</a>
                    </div>

                    <div class="tips-well">
                        <p class="muted"><i class="icon-flag"></i> Did you know you can use the command line utilities <a href="https://github.com/objectrocket/rocketstat">rocketstat</a> and <a href="https://github.com/objectrocket/rockettop">rockettop</a> to show performance via the API similar to mongostat and mongotop?</p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- % include 'credit_card_management.html' % -->

{% endblock content_area_body %}

{% block script %}
    {{ super() }}
    <script type="text/javascript">

    // FIXME:
    // timeseries graphs
    var opcountersURL = "{ url_for('api_timeseries', name='opcounters', selected_instance=instance.name) }";
    var networkURL = "{ url_for('api_timeseries', name='network', selected_instance=instance.name) }";
    var diskURL = "{ url_for('api_timeseries', name='disk', selected_instance=instance.name) }";

    function getTimeseriesData(url,name){
    $.get(url, {}, function(data) {
      // console.log(data);
      name.updateOptions( { 'file': data } );
    });
    }

    var g1 = new Dygraph(
    document.getElementById("graphdiv1"),
    opcountersURL,
    {
      legend: "always",
      fillGraph: true,
      gridLineColor: "#cccccc",
      height: 100,
      labelsDiv: "graphdiv-legend1",
      labelsSeparateLines: false,
      axisLabelFontSize: 10,
      axisLabelColor: "#333333",
      axisLineColor: "#333333",
      maxNumberWidth: 12,
      labels: [ "Date", "Getmore", "Insert", "Update", "Command", "Query", "Delete" ]
    }
    );

    var g2 = new Dygraph(
    document.getElementById("graphdiv2"),
    networkURL,
    {
      legend: "always",
      fillGraph: true,
      gridLineColor: "#cccccc",
      height: 100,
      labelsDiv: "graphdiv-legend2",
      labelsSeparateLines: false,
      axisLabelFontSize: 10,
      axisLabelColor: "#333333",
      axisLineColor: "#333333",
      maxNumberWidth: 12,
      labelsKMG2: true,
      labels: [ "Date", "BytesOut", "BytesIn" ]
    }
    );

    var g3 = new Dygraph(
    document.getElementById("graphdiv3"),
    diskURL,
    {
      legend: "always",
      fillGraph: true,
      gridLineColor: "#cccccc",
      height: 100,
      labelsDiv: "graphdiv-legend3",
      labelsSeparateLines: false,
      axisLabelFontSize: 10,
      axisLabelColor: "#333333",
      axisLineColor: "#333333",
      maxNumberWidth: 12,
      labelsKMG2: true,
      stackedGraph: false,
      labels: [ "Date", "Data Size", "File Size", "Storage Size", "Index Size" ]
    }
    );

    // set an elements value
    function setElement(id,value){
    if (id != "" && id != null && id != " "){
       document.getElementById(id).innerHTML = value;
    }
    }

    // set an elements class
    function setElementClass(id,value){
    if (id != "" && id != null && id != " "){
       document.getElementById(id).className = value;
    }
    }

    // get an elements value
    function getElement(id){
    return document.getElementById(id).innerHTML;
    }

    function serverStatus(d){
    stats = ['query','insert','update','delete','command'];
    for ( var i = 0; i < stats.length; i++ ){
      setElement(stats[i],d['data']['opcounters'][stats[i]]);
    }
    }

    // FIXME:
    function fetchServerStatus(){
    $.getJSON("{ url_for('api_serverstatus', selected_instance=instance.name) }", {}, function(json) {
    //console.log(json);
    serverStatus(json);
    });
    }

    function refresh_status_box() {
    $.getJSON('/api_status', function(data) {
      var statuses = ['status-success', 'status-important', 'status-warning'];

      data.data.forEach(function(element) {
        var selector = $('#' + element._id),
            status   = statuses[element.status];

        if(!selector.hasClass(status)) {
          selector.removeClass();
          selector.addClass('status');
          selector.addClass(status);
        }

      });
    });
    }


    $(document).ready(function() {
        $('.status').tooltip({"placement": "top"});
        refresh_status_box();
        setInterval(refresh_status_box, 9000);

        fetchServerStatus();
        setInterval('fetchServerStatus()',9000);

        // Timeseries.
        setInterval('getTimeseriesData(opcountersURL,g1)',4000);
        setInterval('getTimeseriesData(networkURL,g2)',4000);
        setInterval('getTimeseriesData(diskURL,g3)',4000);

        // Init popovers.
        $("[rel=status_what]").popover({"placement":"left","html":true});
        $("[rel=plan_what]").popover({"placement":"left","html":true});
        $("[rel=messages_what]").popover({"placement":"left","html":true});

        var loaded=true;
    });
    </script>
{% endblock script %}
