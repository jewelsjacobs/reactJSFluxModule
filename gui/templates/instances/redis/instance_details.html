{% extends 'web_app_base.html' %}

{% block back_link_area %}
    {% call back_link() %}
        <a href="{{ url_for('instances') }}">&lsaquo; Back to Instances</a>
    {% endcall %}
{% endblock back_link_area %}

{% block content_area_body %}
    <div class="rs-detail-header">
        <div class="rs-detail-header-actions">
            <div class="rs-dropdown">
                <button id="action-target" class="rs-btn rs-btn-action rs-dropdown-toggle">
                    <span class="rs-cog"></span>
                    Actions
                    <span class="rs-caret"></span>
                </button>
                <ul class="rs-dropdown-menu" style="right:0;">
                    <li><span class="rs-dropdown-category">Manage</span></li>
                    <li><a data-popover="rename-instance-popover" data-popover-target="action-target" data-popover-position="left" class="rs-btn rs-btn-link rs-popover-source">Rename</a></li>
                    <li><a data-popover="delete-instance-popover" data-popover-target="action-target" data-popover-position="left" class="rs-btn rs-btn-link rs-popover-source">Delete</a></li>
                    <li><span class="rs-dropdown-category">Views</span></li>
                    <li><a class="rs-btn rs-btn-link or-expand-all">Expand All</a></li>
                    <li><a class="rs-btn rs-btn-link or-collapse-all">Collapse All</a></li>
                </ul>
            </div>
        </div>
        <div class="rs-detail-header-subtitle">Instance Details</div>
        <div class="rs-detail-header-title">{{ instance.name }}</div>
    </div>

    {% if instance.network == Constants.RAX_SERVICE_NET %}
        <p class="warning_message">

            <img src="/static/art/warning.png" />
            <strong>Note: </strong>
            Because this instance uses the ServiceNet network, it is not accessible via the
            internet and some UI features are not available.
        </p>
    {% endif %}

    {% call detail_section(title='Instance Details', id='details_section') %}
        <ul class="rs-detail-list">
            <li class="rs-detail-item">
                <div class="rs-detail-key">Engine</div>
                <div class="rs-detail-value">{{ Constants.SERVICE_DISPLAY_NAMES[instance.service] }}</div>
            </li>
            <li class="rs-detail-item">
                <div class="rs-detail-key">Service Type</div>
                <div class="rs-detail-value">{{ Constants.TYPE_DISPLAY_NAMES[instance.type] }}</div>
            </li>
            <li class="rs-detail-item">
                <div class="rs-detail-key">Version</div>
                <div class="rs-detail-value">{{ instance.version }}</div>
            </li>
            <li class="rs-detail-item">
                <div class="rs-detail-key">Zone</div>
                <div class="rs-detail-value">{{ instance.zone }}</div>
            </li>
            <li class="rs-detail-item">
                <div class="rs-detail-key">Plan</div>
                <div class="rs-detail-value">
                {% if instance.plan < 1000 %}
                    {{ instance.plan }} MB
                {% elif instance.plan % 1000 != 0 %}
                    {{ instance.plan / 1000 }} GB
                {% else %}
                    {{ int(instance.plan / 1000) }} GB
                {% endif %}
                </div>
            </li>
            <li class="rs-detail-item">
                <div class="rs-detail-key">Connect String</div>
                <div class="rs-detail-value">{{ instance.connect_string }}</div>
            </li>
            <li class="rs-detail-item">
                <div class="rs-detail-key">Password</div>
                <div class="rs-detail-value">{{ instance.password }}</div>
            </li>

                <li class="rs-detail-item">
                    <div class="rs-detail-key">Space Usage</div>
                    <div id="space_usage_data" class="rs-detail-value">

                        {% if instance.runtime_info %}
                            <div class="rs-progress">
                                <div class="rs-progress-inner or-flexbox-row">
                                    <div id="usage-bar-ns" class="rs-segment" style="width: {{ instance.free_space_percentage }}%;">
                                        <div class="rs-bar or-bar-ns"></div>
                                    </div>
                                </div>
                            </div>
                            <span class="or-legend tip" data-title="The total used memory as returned via INFO used_memory_human" data-delay="0.1"><span class="or-legend-ns"></span>usedmemory: {{ instance.runtime_info.get("used_memory_human")}}</span>
                        {% else %}
                            <span class="unavailable">Unavailable</span>
                        {% endif %}

                    </div>
                </li>
                <li class="rs-detail-item">
                    <div class="rs-detail-key">Max Memory Policy</div>
                    <div class="rs-detail-value">
                        {% if instance.config_database %}
                            {{ instance.config_database['maxmemory-policy'] }}
                        {% else %}
                            <span class="unavailable">Unavailable</span>
                        {% endif %}
                    </div>
                </li>
                <li class="rs-detail-item">
                    <div class="rs-detail-key">Max Clients</div>
                    <div class="rs-detail-value">
                        {% if instance.config_database %}
                            {{ instance.config_database['maxclients'] }}
                        {% else %}
                            <span class="unavailable">Unavailable</span>
                        {% endif %}
                    </div>
                </li>
                <li class="rs-detail-item">
                    <div class="rs-detail-key">Connected Slaves</div>
                    <div class="rs-detail-value">
                        {% if instance.runtime_info %}
                            {{ instance.runtime_info.get("connected_slaves") }}
                        {% else %}
                            <span class="unavailable">Unavailable</span>
                        {% endif %}
                    </div>
                </li>
        </ul>
    {% endcall %}

    {% call detail_section(title='Security', collapsible=True, expanded=False, id='acls_section') %}
        <div class="rs-btn-group">
            <button id="add-acl-target" data-popover="add-acl-popover" data-popover-target="add-acl-target" data-popover-position="bottom-right" class="rs-btn rs-btn-primary rs-popover-source">Add ACL</button>
        </div>

        <div class="rs-embedded-list-table-wrapper rs-embedded-medium">
            <table class="rs-list-table rs-embedded-list-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Source IP CIDR</th>
                        <th>Action</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="acls-table-body">
                </tbody>
            </table>
            <div id="acls-table-overlay" class="rs-table-overlay">
                <div class="rs-table-overlay-content">
                    <div class="rs-table-overlay-title">You don't have any ACLs yet.</div>
                    <div class="rs-table-overlay-subtitle">Create one now by clicking on the Add ACL button.</div>
                    <div class="rs-table-overlay-message">Access Control Lists (ACLs) allow you to limit who connects to your instance.</div>
                </div>
            </div>
        </div>
    {% endcall %}

{% endblock content_area_body %}

{% block popovers %}
    <!-- rename instance popover -->
    <div id="rename-instance-popover" class="rs-popover invisible">
        <div class="rs-popover-arrow"></div>
        <div class="rs-popover-content">
            <div class="rs-popover-body">
                <form id="rename_instance_popover_form" class="rs-form-horizontal rs-form-small" action="{{ url_for('rename_instance') }}" method="POST">
                    <div class="rs-control-group">
                        <label class="rs-control-label">New Name</label>
                        <div class="rs-controls">
                            <input name="new_name" type="text" placeholder="{{ instance.name }}" class="rs-input rs-input-medium">
                            <input name="current_name" type="hidden" value="{{ instance.name }}">
                        </div>
                    </div>
                </form>
            </div>
            <div class="rs-popover-footer rs-btn-group">
                <button id="rename_instance_popover_form_button" form="rename_instance_popover_form" class="rs-btn rs-btn-primary save">Rename</button>
                <div class="rs-btn rs-btn-link">Cancel</div>
            </div>
        </div>
    </div>
    <!-- end rename instance popover -->

    <!-- delete instance popover -->
    <div id="delete-instance-popover" class="rs-popover invisible">
        <div class="rs-popover-arrow"></div>
        <div class="rs-popover-content">
            <div class="rs-popover-body">
                <form id="delete-instance-popover-form" class="rs-form-horizontal rs-form-small" action="{{ url_for('delete_instance', instance_name=instance.name) }}" method="POST">
                    <p><b>Permanently delete</b> instance <b>{{ instance.name }}</b>?</p>
                    <p>This will permanently delete the instance and all of its data.</p>
                </form>
            </div>
            <div class="rs-popover-footer rs-btn-group">
                <button id="delete-instance-popover-form-button" form="delete-instance-popover-form" class="rs-btn rs-btn-primary save">Delete Instance</button>
                <div class="rs-btn rs-btn-link">Cancel</div>
            </div>
        </div>
    </div>
    <!-- end delete instance popover -->

    <!-- add acl popover -->
    <div id="add-acl-popover" class="rs-popover invisible">
        <div class="rs-popover-arrow"></div>
        <div class="rs-popover-content">
            <div class="rs-popover-body">
                <form id="add-acl-popover-form" class="rs-form-horizontal rs-form-small" action="{{ url_for('add_acl', instance=instance.name) }}" method="POST">
                    <p>Access Control Lists (ACLs) allow you to limit who connects to your Redis instance. By default, no one is allowed to connect. If you know the set of IP addresses you wish to connect from, you can add them here. If you don't, or if you're connecting from a service such as Heroku that uses dynamic ranges of IP addresses, you can select "any" here; You'll still be able to limit access via the auth key, and you can still encrypt your connections with SSL.</p>
                    <div class="rs-control-group">
                        <label class="rs-control-label">IP Address</label>
                        <div class="rs-controls">
                            <input id="acl" name="cidr_mask" type="text" placeholder="1.1.1.1/24" class="rs-input rs-input-large">
                            <p class="rs-help-block">Must be a <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="1">CIDR</a> IP address, or <span class="strong-blue">any</span> to allow any source IP.</p>
                        </div>
                    </div>
                    <div class="rs-control-group">
                        <label class="rs-control-label">Description</label>
                        <div class="rs-controls">
                            <input id="description" name="description" type="text" class="rs-input rs-input-large">
                            <p class="rs-help-block">Enter a short description for this ACL.</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="rs-popover-footer rs-btn-group">
                <button id="add-acl-popover-form-button" form="add-acl-popover-form" class="rs-btn rs-btn-primary">Add ACL</button>
                <button class="rs-btn rs-btn-link">Cancel</button>
            </div>
        </div>
    </div>
    <!-- end add acl popover -->

    <!-- delete acl popover -->
    <div id="delete-acl-popover" class="rs-popover invisible">
        <div class="rs-popover-arrow"></div>
        <div class="rs-popover-content">
            <div class="rs-popover-body">
                <form id="delete-acl-popover-form" class="rs-form-horizontal rs-form-small" action="{{ url_for('delete_acl', instance=instance.name) }}" method="POST">
                    <p><strong>Delete</strong> ACL <span id="delete-acl-popover-cidr"></span>?</p>
                    <input id="delete-acl-input" name="acl_id" type="hidden" value="">
                </form>
            </div>
            <div class="rs-popover-footer rs-btn-group">
                <button id="delete-acl-popover-form-button" form="delete-acl-popover-form" class="rs-btn rs-btn-primary">Delete ACL</button>
                <button class="rs-btn rs-btn-link">Cancel</button>
            </div>
        </div>
    </div>
    <!-- end delete acl popover -->

{% endblock popovers %}

{% block script %}
    {{ super() }}
    <script type="text/javascript">

    // Instance API key and name.
    var apiKey = {{ instance.api_key|tojson|safe }};
    var instanceName = '{{ instance.name }}';

    // Render ACL data into the ACLs table.
    function displayACLs() {
        var apiURL = "/api/acls/" + apiKey;

        $.ajax({
            url: apiURL,
            dataType: 'json',
            type: 'POST',
            data: {},
            success: function(jsonData) {
                var aclData = jsonData['data'];
                $aclsTableBody = $('#acls-table-body');

                // If ACLs are found, then remove the table overlay.
                if (aclData.length > 0) {
                    $('#acls-table-overlay').addClass('hidden');
                }

                // Map each ACL onto this function.
                aclData.map(function(aclObject) {
                    var cidrMask = aclObject['cidr_mask'];
                    var description = aclObject['description'] ? aclObject['description'] : "";
                    var id = aclObject['_id']['$oid'];
                    var instance = aclObject['instance'];

                    // Construct the delete button.
                    var $deleteButton = $('<button>');
                    $deleteButton.attr('id', 'delete-acl-target-' + id);
                    $deleteButton.attr('data-popover', 'delete-acl-popover');
                    $deleteButton.attr('data-popover-target', 'delete-acl-target-' + id);
                    $deleteButton.attr('data-popover-position', 'right');
                    $deleteButton.addClass('rs-delete rs-popover-source');

                    // Construct the table row.
                    var $aclEntry = $('<tr>');
                    $aclEntry.append($('<td>').append($deleteButton));
                    $aclEntry.append($('<td>').text(cidrMask));
                    $aclEntry.append($('<td>').text('Allow'));
                    $aclEntry.append($('<td>').text(description));

                    // Append the table row to the acls table body.
                    $aclsTableBody.append($aclEntry);

                    // Bind popover listeners on new elements.
                    $deleteButton.click(function() {
                        if(!$deleteButton.prop('disabled')) {
                            // Inject pertinent content into popover.
                            $('#delete-acl-popover-cidr').text(cidrMask);
                            $('#delete-acl-input').val(id);

                            // Position and show popover.
                            positionPopover($deleteButton);
                            showPopover($deleteButton);
                        }
                    });
                });
            }
        });
    }

    function asyncCallOnExpand($section, asyncCall) {
        $section.click(function() {
            if (!$section.attr('data-called')) {
                asyncCall();
                $section.attr('data-called', true);
            }
        });
    }

    $(document).ready(function() {

        // Asynchronous calls.
        asyncCallOnExpand($('#acls_section'), displayACLs);

        // Validation for renaming instances.
        $('#rename_instance_popover_form').validate({
            rules: {
                new_name: {
                    alphanumeric: true,
                    minlength: 2,
                    nowhitespace: true,
                    required: true
                }
            },
            errorClass: 'rs-validation-block',
            errorElement: 'span',
            highlight: function (label) {
                $(label).closest('.rs-control-group').removeClass('success');
                $(label).closest('.rs-control-group').addClass('error');
            },
            success: function (label) {
                $(label).closest('.rs-control-group').removeClass('error');
                $(label).closest('.rs-control-group').addClass('success');
            }
        });

        $('#rename_instance_popover_form').bind("change keyup", function () {
            if ($(this).validate().checkForm()) {
                $("#rename_instance_popover_form_button").attr('disabled', false);
            } else {
                $('#rename_instance_popover_form_button').attr('disabled', true);
            }
        });

        // Validation for adding instance users.
        $('#add-instance-user-popover-form').validate({
            rules: {
                username: {
                    minlength: 2,
                    nowhitespace: true,
                    required: true
                },
                password: {
                    minlength: 2,
                    required: true
                },
            },
            errorClass: 'rs-validation-block',
            errorElement: 'span',
            highlight: function (label) {
                $(label).closest('.rs-control-group').removeClass('success');
                $(label).closest('.rs-control-group').addClass('error');
            },
            success: function(label) {
                $(label).closest('.rs-control-group').removeClass('error');
                $(label).closest('.rs-control-group').addClass('success');
            }
        });


    });
    </script>
{% endblock script %}
